---
title: "Unveiling Vulnerability - Index Data Cleaning"
subtitle: "Thesis for a Master of Public Health"
author: "Nathan Garcia-Diaz"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
    latex_engine: lualatex
  output: github_document
urlcolor: blue
---

\newpage

# Person Statement

The code will import and clean data for the Center for Disease Control 2022 Version of the Social Vulnerability Index ([Data & Documentation link](https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html)), the Environmental Justice Index ([Data link](https://www.atsdr.cdc.gov/placeandhealth/eji/eji-data-download.html); [Documentation link](https://www.atsdr.cdc.gov/placeandhealth/eji/technical_documentation.html)), and the Rhode Island Health Equity Index (link provided if and when available). The website inputs include Year = 2022 (when applicable), Geography = Rhode Island, and File Type = CSV File.

*Please note that while data can be downloaded at state or national geographies, rankings within both geographic levels of these data represent comparisons to all other census tracts in the nation. For example, an EJI ranking of 0.85 signifies that 85% of tracts in the nation likely experience less severe cumulative impacts from environmental burden than the tract of interest, and that 15% of tracts in the nation likely experience more severe cumulative impacts from environmental burden.*

Inputs: raw Social Vulnerability Index (SVI) and Environmental Justice Index (EJI) files downloaded from the provided links Outputs: two csv file that will be inputs for the `SVI_EDA.rmd` and `EJI_EDA.rmd` files, respectively.

SVI Suggested Citation: Centers for Disease Control and Prevention/ Agency for Toxic Substances and Disease Registry/ Geospatial Research, Analysis, and Services Program. CDC/ATSDR Social Vulnerability Index [2022] Database [Rhode Island]. <https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html>. Accessed on [07/2024].

EJI Suggested Citation: Centers for Disease Control and Prevention and Agency for Toxic Substances Disease Registry. 2022 Environmental Justice Index. Accessed [07/2024]. <https://www.atsdr.cdc.gov/placeandhealth/eji/index.html>

```{r defining global settings, include = FALSE}
knitr::opts_chunk$set(error = FALSE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = "/Users/ngarciad/OneDrive - Brown University/Documents/GitHub/MPH-Thesis_GeographicalRandomForest")
options(tigris_use_cache = TRUE)
```

\newpage

# Preparation

The following two outputs were generated by the `str(df)` function, and they provide an initial peak into the raw data files. Note that the that "raw" files from the were changed given their initial similarity. SVI initially was called "RhodeIsland.csv", but in the project directory it is called "SVI_RI_Data.csv'. Meanwhile, the EJI was called "Rhode Island.csv", and it is now called "EJI_RI_Data.csv" The renaming of files was preformed in the File Explorer.

```{r importing packages and data}
# Importing Packages
library(tidyverse) # general data manipulation
library(knitr)     # Rmarkdown interactions
library(janitor)   # cleans the column names 
library(here)      # define top level of project folder
                        # this allows for specification of where 
                        # things live in relation to the top level
library(readr)     # imports csv files
library(naniar)    # missing data visualization
library(tigris)    # obtaining shp files 
library(distill)   # markdown settings

# Importing Data
svi = read_csv(here::here("01_Data", "SVI_RI_Data.csv"))
eji = read_csv(here::here("01_Data", "EJI_RI_Data.csv"))
```

\newpage

# Data Cleaning

The following sections will be applied to the Social Vulnerability Index, the Environmental Justice Index, and the Rhode Island Health Equity Index:

-   Trimming, Renaming, and Changing Data Types of Columns
-   Determining Missing Data Entries and Peculiar Values
-   Investigation of Missing Data

## Social Vulnerability Index

### Trimming, Renaming, and Changing Data Types of Columns

This section is completely about personal preference. I do not like to code with capital letters, therefore I like to use the the `janitor::clean_names(df)`, which will create columns names that are in snake case and contain letters in lower case. Lastly, `geoid` will be changed to a chr variable type to ensure ease in future data joins. The data initially has `r nrow(svi)` observations, however there are 244 cesus tracts according to the [United States Census Bureau](https://www.census.gov/geographies/reference-files/2010/geo/state-local-geo-guides-2010/rhode-island.html#:~:text=All%20MCD%20and%20place%20governments,are%20independent%20of%20county%20subdivisions.&text=Rhode%20Island%20has%20244%20census,groups%2C%20and%2025%2C181%20census%20blocks.)

```{r svi - data prep}
svi_cleaned = svi %>% 
  clean_names() %>% 
  select(
    # administrative data
    fips, location, 
    # summary value 
    rpl_themes, 
    # predictor values 
    starts_with("e_"),
    # removing undesirable columns
    -e_totpop, -e_hu, -e_hh, -(e_daypop:e_otherrace)) %>% 
  mutate(fips = as.character(fips))
```

### Determining Missing Data Entries and Peculiar Values

Census tracts with NA for could be missing values for multiple reasons. Please refer to the CDC/ASTR Technical Documentation for the 2022 Version of the Environmental Justice Index. Given that the missing data represents `r round(nrow(svi_cleaned %>% select(-fips, -location) %>% filter(rpl_themes == -999))/nrow(svi_cleaned), 3)*100`% of the entire data, permutations will not be implemented, and an examination of the missing data will be preformed in the following section. `eji_df` is defined in this section, and it serves as the working file for the following `.rmd` files.

```{r svi - handling missing data}
## examination of variables 
svi_cleaned %>% select(-fips, -location) %>% summary()
# conclusion: there seems to be a few particular entries

## examination of variables that do not contain NAs
svi_cleaned %>% 
  select(-fips, -location) %>% 
  filter(!(rpl_themes == -999)) %>% 
  summary()
# conclusion: the removal of the NA values seems to have corrected the data 
# continue by dropping these values

## redefining the eji_df
svi_df = svi_cleaned %>% filter(!(rpl_themes == -999))
```

### Investigation of Missing Data

A summary of the missing data is illustrated below. The graph illustrates combinations of missingness and intersections of missingess amongst variables. Despite 3 census tracts being listed as having NA columns, it seems that the airport is the only census tract to be missing from the map. [DataCommon.org](https://datacommons.org/place/geoId/44005990000) states that census tract 44005990000 contains no a small island off the coast of Gooseberry Beach, Newport. [CensusReporter.org](https://censusreporter.org/profiles/14000US44009990100-census-tract-9901-washington-ri/) illustrates census tract 44009990100 is primarily coast line with no real population. All three census tracts contain no permanent population, and therefore some themes could not be calculated, which prevent a final summary index from being calculated.

```{r svi - missing data investigation}
temp = svi_cleaned %>% filter(rpl_themes == -999)

# visualization of missing data
print(temp)

# filtering for missing census tracts
lst_missing = c("44003980000") # airport: population 0

# obtaining census tracts 
ri_tracts = tracts(state = "RI", cb = TRUE)

# creating temporary data frame
temp_tracts = ri_tracts %>%
  mutate(missing_data = as.character(ifelse(GEOID %in% lst_missing, 1,0)))
  
# making the data
ggplot(temp_tracts, aes(fill = missing_data)) + geom_sf() + theme_void()
```

The following code exports the `eji_df` as a csv file. This file will be used in the subsequent `.rmd` files.

```{r svi - print final code}
write.csv(svi_df, 
          "/Users/ngarciad/OneDrive - Brown University/Documents/GitHub/MPH-Thesis_GeographicalRandomForest/01_Data/svi_df.csv")
```

\newpage

## Enviormental Justice Index

### Trimming, Renaming, and Changing Data Types of Columns

This section is completely about personal preference. I do not like to code with capital letters, therefore I like to use the the `janitor::clean_names(df)`, which will create columns names that are in snake case and contain letters in lower case. Lastly, `geoid` will be changed to a chr variable type to ensure ease in future data joins. The data initially has `r nrow(eji)` observations, however there are 244 census tracts according to the [United States Census Bureau](https://www.census.gov/geographies/reference-files/2010/geo/state-local-geo-guides-2010/rhode-island.html#:~:text=All%20MCD%20and%20place%20governments,are%20independent%20of%20county%20subdivisions.&text=Rhode%20Island%20has%20244%20census,groups%2C%20and%2025%2C181%20census%20blocks.)

```{r eji - trimming and renamng columns}
eji_cleaned = eji %>% 
  clean_names() %>% 
  select(
    # administrative Information
    geoid, location, 
    # summary index value 
    rpl_eji, 
    # environmental burden
    starts_with("e_"), 
    # social vulnerability
    starts_with("ep_"), 
    # health vulnerability 
    starts_with("f_'"),
    # undesirable columns
    -e_totpop, -e_daypop) %>% 
  mutate(geoid = as.character(geoid))
```

### Determining Missing Data Entries and Peculiar Values

Census tracts with NA for could be missing values for multiple reasons. Please refer to the CDC/ASTR Technical Documentation for the 2022 Version of the Environmental Justice Index. Given that the missing data represents `r round(1 - nrow(eji_cleaned %>% select(-geoid, -location) %>% filter(!is.na(rpl_eji)))/nrow(eji_cleaned), 3)*100`% of the entire, permutations will not be implemented, and an examination of the missing data will be preformed in the following section. `eji_df` is defined in this section, and it serves as the working file for the following `.rmd` files.

```{r eji - handling missing data}
## examination of variables 
eji_cleaned %>% 
  select(-geoid, -location) %>% 
  summary()
# conclusion: there seems to be a few particular entries

## examination of variables that do not contain NAs
eji_cleaned %>% 
  select(-geoid, -location) %>% 
  filter(!is.na(rpl_eji)) %>% 
  summary()
# conclusion: the removal of the NA values seems to have corrected the data 
# continue by dropping these values

## redefining the eji_df
eji_df = eji_cleaned %>% filter(!is.na(rpl_eji))
```

### Investigation of Missing Data

A summary of the missing data is illustrated below. The graph illustrates combinations of missingness and intersections of missingess amongst variables. Despite 3 census tracts being listed as having NA columns, it seems that the airport is the only census tract to be missing from the map. [DataCommon.org](https://datacommons.org/place/geoId/44005990000) states that census tract 44005990000 contains no a small island off the coast of Gooseberry Beach, Newport. [CensusReporter.org]((https://censusreporter.org/profiles/14000US44009990100-census-tract-9901-washington-ri/)) illustrates census tract 44009990100 is primarily coast line with no real population. All three census tracts contain no permanent population, and therefore some themes could not be calculated, which prevent a final summary index from being calculated.

```{r eji - missing data investigation}
temp = eji_cleaned %>% filter(is.na(rpl_eji))

# visualization of missing data
print(temp)
```

\newpage 

```{r, fig.height=8}
gg_miss_upset(temp, nsets = n_var_miss(temp))
```

\newpage

```{r}
gg_miss_var(temp)
```

\newpage

```{r}

# filtering for missing census tracts
lst_missing = c("44003980000", # airport: population 0
                "44005990000", # new port county: population 0
                "44009990100") # washington county Rhode island: population 0

# creating temprary data frame
temp_tracts = ri_tracts %>%
  mutate(missing_data = as.character(ifelse(GEOID %in% lst_missing, 1,0)))
  
# making the 
ggplot(temp_tracts, aes(fill = missing_data)) + geom_sf() + theme_void()
```

The following code exports the `eji_df` as a csv file. This file will be used in the subsequent `.rmd` files.

```{r eji - printing final csv}
write.csv(eji_df, 
          "/Users/ngarciad/OneDrive - Brown University/Documents/GitHub/MPH-Thesis_GeographicalRandomForest/01_Data/eji_df.csv")
```
